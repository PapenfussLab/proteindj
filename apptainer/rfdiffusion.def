Bootstrap: docker
From: nvidia/cuda:12.4.1-base-ubuntu22.04

%post
    # Install build deps
    apt-get -q update
    DEBIAN_FRONTEND=noninteractive apt-get install --no-install-recommends -y \
        git \
        python3-pip \
        build-essential

    # Clone the RFdiffusion repository
    git clone https://github.com/PapenfussLab/RFdiffusion /app/RFdiffusion 
    cd /app/RFdiffusion && git checkout 0938f87

    # Install the provided versions of pip packages
    pip install --no-cache-dir \
        dgl==2.4.0 -f https://data.dgl.ai/wheels/torch-2.4/cu124/repo.html \
        torch==2.4.0 -f https://download.pytorch.org/whl/cu124 \
        e3nn==0.5.8 \
        wandb==0.23.0 \
        pynvml==13.0.1 \
        git+https://github.com/NVIDIA/dllogger#egg=dllogger \
        decorator==5.2.1 \
        hydra-core==1.3.2 \
        pyrsistent==0.20.0 \
        icecream==2.1.8 \
        "jax[cuda12]==0.5.3" \
        dm-haiku==0.0.15 \
        dm-tree==0.1.9 \
        biopython==1.86 \
        ml-collections==1.1.0 \
        tensorflow==2.20.0 \
        /app/RFdiffusion/env/SE3Transformer

    # Install RFdiffusion
    pip install --no-cache-dir /app/RFdiffusion --no-deps

    # Clean up
    rm -rf /var/lib/apt/lists/*
    apt-get autoremove -y
    apt-get clean

%environment
    export DGLBACKEND="pytorch"

%test
    DGLBACKEND="pytorch" python3 /app/RFdiffusion/scripts/run_inference.py --help

%runscript
    if [ $# -eq 0 ]; then
        exec /bin/bash --norc
    else
        exec python3 /app/RFdiffusion/scripts/run_inference.py "$@"
    fi

%labels
    Author JulieIskander, DylanSilke, JoshuaHardy
    Version 2.2
    Description "Apptainer container for RFdiffusion"

%help
    Container for running RFdiffusion with CUDA 12.8
    Execute with GPU support using: apptainer run --nv rfdiffusion.sif
