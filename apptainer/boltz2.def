# Build stage - install dependencies and compile
Bootstrap: docker
Stage: build
From: nvidia/cuda:12.8.0-base-ubuntu24.04

%post
    # install build deps
    apt-get -q update
    DEBIAN_FRONTEND=noninteractive apt-get install --no-install-recommends -y \
        git \
        wget \
        python-dev-is-python3 \
        python3-venv \
        python3-pip \
        build-essential \
        software-properties-common

    # create and activate virtual environment
    python3 -m venv /opt/venv
    . /opt/venv/bin/activate

    # install boltz
    git clone https://github.com/jwohlwend/boltz.git && cd /boltz && git checkout cb04aec
    pip install --no-cache-dir ".[cuda]"

    # cleanup build dependencies
    apt-get autoremove -y
    apt-get clean
    
    # link venv
    echo '. /opt/venv/bin/activate' >> $APPTAINER_ENVIRONMENT
    
%runscript
    cd /boltz
    if [ $# -eq 0 ]; then
        exec /bin/bash --norc
    else
        exec "$@"
    fi

%test
    . /opt/venv/bin/activate
    cd /boltz
    export NUMBA_CACHE_DIR=/tmp
    export XDG_CONFIG_HOME=/tmp
    export TRITON_CACHE_DIR=/tmp
    boltz --help
    echo "Build tests completed sucessfully"

%help
    Boltz container with CUDA 12.8 runtime
