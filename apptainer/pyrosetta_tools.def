Bootstrap: docker
From: mambaorg/micromamba:1.5.8

%post -c /bin/bash
    apt-get update && apt-get upgrade -y
    apt-get install -y \
        wget \
        unzip \
        git \
        procps \
        coreutils \
        grep \
        pigz \
        sed

    # Setup micromamba environment
    micromamba create -n pyrosetta -c conda-forge python=3.9 pip pyyaml -y
    eval "$(micromamba shell hook --shell bash)"
    micromamba activate pyrosetta

    # Install pyrosetta
    export PIP_NO_CACHE_DIR=1
    pip install pyrosetta-installer 
    python -c 'import pyrosetta_installer; pyrosetta_installer.install_pyrosetta()'

    # Install pip packages (including CPU-version of PyTorch)
    pip install biopython pandas matplotlib
    pip install torch torchvision --index-url https://download.pytorch.org/whl/cpu

    apt-get autoremove -y
    apt-get clean
    micromamba clean --all --yes

%environment
    # so we can just run it out of the box without having to set the prefix
    export PATH=/opt/conda/envs/pyrosetta/bin:$PATH

# Entry point for the container when run.
%runscript
    exec "$@"

%labels
    Author JulieIskander, DylanSilke, JoshuaHardy
    Version 2.2
    Description "Apptainer container for PyRosetta and other tools for ProteinDJ"